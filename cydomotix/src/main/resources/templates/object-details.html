<!DOCTYPE html>
<!-- Importer Thymeleaf Security -->
<html lang="fr" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">

<head>
    <meta charset="UTF-8">
    <title>Consulter un objet connecté</title>
    <script src="/js/interactionDate.js" defer></script>
    <script src="/js/objectDetails.js" defer></script>
</head>
<body>

    <div>
        <table>
            <tr>
                <th colspan="2" th:text="${connectedObject.name}"></th>
            </tr>
            <tr>
                <td colspan="2" style="text-align: center" th:text="${connectedObject.objectType.name}"></td>
            </tr>
            <tr>
                <td colspan="2" style="text-align: center" th:text="${connectedObject.room.name}"></td>
            </tr>
            <tr>
                <td>Marque :</td>
                <td th:text="${connectedObject.brand}"></td>
            </tr>
            <tr>
                <td>Mode :</td>
                <td th:text="${connectedObject.mode.displayName}"></td>
            </tr>
            <tr>
                <td>Connectivité :</td>
                <td th:text="${connectedObject.connectivity.displayName}"></td>
            </tr>
            <tr>
                <td>État de batterie :</td>
                <td th:text="|${connectedObject.batteryStatus}%|"></td>
            </tr>
            <tr th:each="attribute, iterStat : ${connectedObject.objectType.attributes}">
                <td>
                    <p th:text="|${attribute.name} :|"></p>
                </td>
                <td>
                    <!-- Affichage conditionnels selon le type de valeur -->
                    <p th:if="${attribute.valueType.name() == 'STRING'}" th:text="${connectedObject.attributeValueList[iterStat.index].string_value}"></p>
                    <p th:if="${attribute.valueType.name() == 'INTEGER'}" th:text="${connectedObject.attributeValueList[iterStat.index].int_value}"></p>
                    <p th:if="${attribute.valueType.name() == 'DOUBLE'}" th:text="${connectedObject.attributeValueList[iterStat.index].double_value}"></p>
                    <p th:if="${attribute.valueType.name() == 'TEMPERATURE'}" th:text="|${connectedObject.attributeValueList[iterStat.index].int_value}&deg;C|"></p>
                    <p th:if="${attribute.valueType.name() == 'HOURS'}" th:text="|${connectedObject.attributeValueList[iterStat.index].int_value}h|"></p>
                    <p th:if="${attribute.valueType.name() == 'MINUTES'}" th:text="|${connectedObject.attributeValueList[iterStat.index].int_value}min|"></p>
                    <p th:if="${attribute.valueType.name() == 'SECONDS'}" th:text="|${connectedObject.attributeValueList[iterStat.index].int_value}s|"></p>
                    <p th:if="${attribute.valueType.name() == 'PERCENTAGE'}" th:text="|${connectedObject.attributeValueList[iterStat.index].int_value}%|"></p>
                </td>
            </tr>
            <tr>
                <td>Dernière interaction :</td>
                <td class="lastInteractionText" th:text="${connectedObject.lastInteraction}"></td>
            </tr>
            <tr>
                <td>Status :</td>
                <td>
                    <p th:if="${connectedObject.isActive == true}">Activé</p>
                    <p th:unless="${connectedObject.isActive}">Désactivé</p>
                    <a class="power-btn" th:href="@{/object/{id}/status(id=${connectedObject.id})}">
                        <button>Activer/Désactiver</button>
                    </a>
                </td>
            </tr>
            <tr sec:authorize="hasRole('ADMIN')">
                <td colspan="2">
                    <a class="delete-btn" href="#" th:data-id="${connectedObject.id}">
                        <button>Supprimer</button>
                    </a>
                </td>
            </tr>
        </table>
    </div>

    <br><br>

    <!-- Edit Form: Only Visible to Admins -->
    <div sec:authorize="hasRole('ADMIN')">
        <form th:action="@{/object/{id}/update(id=${connectedObject.id})}" method="POST" th:object="${connectedObject}">
            <!-- Champs invisible mais nécessaire pour que le formulaire envoyé à la requête associe correctement ces champs à l'objet récupéré -->
            <input type="hidden" th:field="*{id}">

            <label for="name">Nom de l'objet :</label>
            <input type="text" id="name" th:field="*{name}">
            <br>

            <!-- Type d'objet en read only pour l'esthétique et pour envoyer les infos complètes avec le form -->
            <label>Type d'objet :</label>
            <input type="text" th:value="${connectedObject.objectType.name}" readonly>
            <br>

            <label>Pièce :</label>
            <select th:field="*{room}" id="room">
                <option th:each="room : ${rooms}" th:value="${room.id}" th:text="${room.name}"></option>
            </select>
            <br>

            <label for="brand">Marque :</label>
            <input type="text" id="brand" th:field="*{brand}">
            <br>

            <label for="mode">Mode :</label>
            <select th:field="*{mode}" id="mode">
                <option th:each="mode : ${T(com.example.cydomotix.Model.Objects.Mode).values()}" th:value="${mode}" th:text="${mode.displayName}"></option>
            </select>
            <br>

            <label for="connectivity">Connectivité :</label>
            <select th:field="*{connectivity}" id="connectivity">
                <option th:each="connectvitiy : ${T(com.example.cydomotix.Model.Objects.Connectivity).values()}" th:value="${connectvitiy}" th:text="${connectvitiy.displayName}"></option>
            </select>
            <br>

            <label for="batteryStatus">État de batterie :</label>
            <input type="number" min="0" max="100" id="batteryStatus" th:field="*{batteryStatus}"><span> %</span>
            <br>

            <h3>Champs :</h3>

            <table id="attributesTable">
                <thead>
                <tr>
                    <th>Attribut</th>
                    <th>Valeur</th>
                </tr>
                </thead>
                <tbody>
                    <tr th:each="attributeValue, index : *{attributeValueList}">
                        <!-- Champs invisible mais nécessaires pour que le formulaire envoyé à la requête associe correctement ces champs à l'objet récupéré -->
                        <input type="hidden" th:field="*{attributeValueList[__${index.index}__].id}" />
                        <input type="hidden" th:field="*{attributeValueList[__${index.index}__].objectAttribute}">
                        <input type="hidden" th:field="*{attributeValueList[__${index.index}__].connectedObject}">

                        <td th:text="${attributeValue.objectAttribute.name}"></td>
                        <td>
                            <!-- Type d'input en fonction du type d'attribut -->
                            <input th:if="${attributeValue.objectAttribute.valueType.name() == 'STRING'}"
                                   type="text" th:field="*{attributeValueList[__${index.index}__].string_value}">
                            <input th:if="${attributeValue.objectAttribute.valueType.name() == 'INTEGER'}"
                                   type="number" th:field="*{attributeValueList[__${index.index}__].int_value}">
                            <input th:if="${attributeValue.objectAttribute.valueType.name() == 'PERCENTAGE'}"
                                   type="number" min="0" max="100" th:field="*{attributeValueList[__${index.index}__].int_value}">
                            <input th:if="${attributeValue.objectAttribute.valueType.name() == 'TEMPERATURE'}"
                                   type="number" min="-100" max="100" th:field="*{attributeValueList[__${index.index}__].int_value}">
                            <input th:if="${attributeValue.objectAttribute.valueType.name() == 'HOURS' ||
                                            attributeValue.objectAttribute.valueType.name() == 'MINUTES' ||
                                            attributeValue.objectAttribute.valueType.name() == 'SECONDS'}"
                                   type="number" min="0" th:field="*{attributeValueList[__${index.index}__].int_value}">
                            <input th:if="${attributeValue.objectAttribute.valueType.name() == 'DOUBLE'}"
                                   type="number" step="0.01" th:field="*{attributeValueList[__${index.index}__].double_value}">

                            <!-- Dimension conditionnelle -->
                            <span th:if="${attributeValue.objectAttribute.valueType.name() == 'PERCENTAGE'}"> %</span>
                            <span th:if="${attributeValue.objectAttribute.valueType.name() == 'TEMPERATURE'}"> °C</span>
                            <span th:if="${attributeValue.objectAttribute.valueType.name() == 'HOURS'}"> h</span>
                            <span th:if="${attributeValue.objectAttribute.valueType.name() == 'MINUTES'}"> min</span>
                            <span th:if="${attributeValue.objectAttribute.valueType.name() == 'SECONDS'}"> s</span>
                        </td>
                    </tr>
                </tbody>
            </table>

            <button type="submit">Enregistrer</button><br>

            <!-- Affichage de l'erreur -->
            <div th:if="${errorMessage}" style="color: red; font-weight: bold;">
                <p th:text="${errorMessage}"></p>
            </div>

            <!-- Affichage du message de succès -->
            <div th:if="${successMessage}" style="color: green; font-weight: bold;">
                <p th:text="${successMessage}"></p>
            </div>

        </form>
    </div>
</body>
</html>